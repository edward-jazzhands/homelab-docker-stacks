services:
  # Use this service for interactive configuration
  rclone-config:
    image: rclone/rclone:latest
    container_name: rclone-config
    volumes:
      - ${DATA_DIR}/rclone-config:/config/rclone
      - ${DATA_DIR}/cloud-drives:/data:shared
    user: "${PUID}:${PGID}"
    stdin_open: true
    tty: true
    entrypoint: ["/bin/sh"]
    profiles:
      - config  # This service won't start with normal 'docker-compose up'

  # Main rclone service for mounting cloud storage
  rclone:
    image: rclone/rclone:latest
    container_name: rclone
    restart: unless-stopped
    volumes:
      # - ${DATA_DIR}/rclone-config:/config/rclone
      - bind:
          create_host_path: false
          propagation: rprivate
        read_only: false
        source: ${DATA_DIR}/rclone-config
        target: /config/rclone
        type: bind
      # # Mount your cloud drives directory with :shared propagation
      # # This allows mounts created inside the container to be visible on the host
      # - ${DATA_DIR}/cloud-drives:/data:shared
      - bind:
          create_host_path: false
          propagation: shared
        read_only: false
        source: ${DATA_DIR}/cloud-drives
        target: /data
        type: bind
      # # Required for FUSE to work
      # - /etc/passwd:/etc/passwd:ro
      - bind:
          create_host_path: false
          propagation: rprivate
        read_only: true
        source: /etc/passwd
        target: /etc/passwd
        type: bind
      # - /etc/group:/etc/group:ro
      - bind:
          create_host_path: false
          propagation: rprivate
        read_only: true
        source: /etc/group
        target: /etc/group
        type: bind

    user: "${PUID}:${PGID}"
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    # Enable if you want the RC web interface
    ports:
      - "5572:5572"
    
    # Mount multiple remotes using a wrapper script
    # The script is defined below and will be created at runtime
    command: >
      sh -c '
      echo "Starting rclone mounts...";
      
      mkdir -p /data/google-drive /data/onedrive /data/dropbox;
      
      # rclone mount gdrive: /data/google-drive \
      #   --allow-other \
      #   --vfs-cache-mode full \
      #   --vfs-cache-max-age 24h \
      #   --dir-cache-time 1h \
      #   --log-level INFO &
      
      # rclone mount onedrive: /data/onedrive \
      #   --allow-other \
      #   --vfs-cache-mode full \
      #   --vfs-cache-max-age 24h \
      #   --dir-cache-time 1h \
      #   --log-level INFO &
      
      # rclone mount dropbox: /data/dropbox \
      #   --allow-other \
      #   --vfs-cache-mode full \
      #   --vfs-cache-max-age 24h \
      #   --dir-cache-time 1h \
      #   --log-level INFO &
      
      echo "All mounts started. Starting Web UI...";
      rcd --rc-web-gui --rc-addr :5572 --rc-user admin --rc-pass "${PASSWORD}"
      '
